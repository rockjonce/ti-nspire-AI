<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TI-Nspire æ•¸å­¸å¯¦é©—å®¤</title>
<style>
  body { 
    font-family: "Times New Roman", "Microsoft JhengHei", serif; 
    margin: 0; padding: 0; 
    background-color: #f0f2f5;
    display: flex; flex-direction: column; 
    align-items: center; justify-content: center;
    height: 100vh;
    overflow: hidden; /* é˜²æ­¢é›™é‡å·è»¸ */
  }

  /* ğŸŸ¢ ä¸»è¦å®¹å™¨ ğŸŸ¢ */
  .main-card {
      background: white;
      width: 90%; max-width: 650px;
      padding: 35px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s ease;
      border-top: 5px solid #003366;
  }

  h2 { margin-top: 0; color: #003366; margin-bottom: 15px; font-weight: bold; letter-spacing: 1px;}
  p.desc { color: #555; font-size: 15px; margin-bottom: 30px; line-height: 1.6;}

  /* é è¦½å€ */
  #preview-area { 
    display: none; padding: 15px; background: #fff; 
    border-radius: 6px; margin-bottom: 20px; position: relative;
    align-items: center; gap: 15px; border: 1px solid #ddd;
    justify-content: center;
  }
   
  #preview-img { height: 80px; border: 1px solid #eee; display: none; object-fit: contain;}
  #preview-pdf { 
      display: none; height: 60px; width: 60px; background: #b30000; color: white;
      border-radius: 4px; text-align: center; line-height: 60px; font-weight: bold; font-size: 14px;
  }

  #file-name-preview { font-size: 14px; color: #333; font-family: monospace; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  #remove-img-btn {
    position: absolute; top: -10px; right: -10px;
    background: #cc0000; color: white;
    border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
    font-size: 14px; line-height: 24px; text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* è¼¸å…¥æ§åˆ¶å€ */
  .input-group { display: flex; gap: 10px; align-items: center; }

  input[type="text"] { 
    flex: 1; padding: 12px 15px; border: 1px solid #ccc; 
    border-radius: 4px; outline: none; font-size: 16px; transition: border-color 0.3s;
    font-family: "Microsoft JhengHei", sans-serif;
  }
  input[type="text"]:focus { border-color: #003366; }

  .icon-btn {
    background: #e6eef5; border: none; cursor: pointer; padding: 10px; width: 45px; height: 45px;
    color: #003366; display: flex; align-items: center; justify-content: center; font-size: 20px;
    border-radius: 4px; transition: background 0.2s;
  }
  .icon-btn:hover { background: #d0dbe7; }
   
  button#send-btn { 
    background-color: #003366; color: white; border: none; 
    padding: 12px 25px; border-radius: 4px; cursor: pointer; font-size: 16px; white-space: nowrap;
    font-weight: bold; box-shadow: 0 2px 5px rgba(0, 51, 102, 0.3); transition: background 0.2s;
  }
  button#send-btn:hover { background-color: #002244; }
  button:disabled { background-color: #ccc; cursor: default; box-shadow: none; }

  /* ğŸŸ¢ å…¨è¢å¹•è¼‰å…¥å‹•ç•« ğŸŸ¢ */
  #loading-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.98); z-index: 2000;
      flex-direction: column; align-items: center; justify-content: center;
  }
  .spinner {
      width: 50px; height: 50px; border: 4px solid #eee; border-top: 4px solid #003366;
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading-text { color: #003366; font-weight: bold; font-size: 18px; letter-spacing: 1px; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

  /* ğŸŸ¢ çµæœå€ (Success View) ğŸŸ¢ */
  #success-view {
      display: none; flex-direction: column; align-items: center; justify-content: center;
  }
  .check-icon {
      font-size: 60px; color: #003366; margin-bottom: 15px;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  .open-report-btn {
      background: #003366; color: white; border: none; padding: 15px 35px; 
      border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 51, 102, 0.3); margin-top: 20px;
      display: flex; align-items: center; justify-content: center;
      gap: 10px; transition: transform 0.2s, background 0.2s;
  }
  .open-report-btn:hover { background: #002244; transform: translateY(-2px); }

  .reset-btn {
      background: none; border: none; color: #777; text-decoration: underline; 
      margin-top: 20px; cursor: pointer; font-size: 14px;
  }

  /* ğŸŸ¢ æ–°å¢ï¼šIframe å‹å–„çš„ Modal (å½ˆå‡ºå±¤) æ¨£å¼ ğŸŸ¢ */
  #report-modal {
      display: none; /* é è¨­éš±è— */
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 3000;
      align-items: center; justify-content: center;
  }
  .modal-content {
      background: white; width: 90%; height: 90%; max-width: 850px;
      border-radius: 8px; position: relative; display: flex; flex-direction: column;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  .modal-header {
      padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
      background: #f8f9fa; border-radius: 8px 8px 0 0;
  }
  .modal-title { font-weight: bold; color: #003366; font-size: 18px; }
  .close-modal-btn {
      background: none; border: none; font-size: 24px; cursor: pointer; color: #666;
  }
  .modal-body {
      flex: 1; padding: 20px; overflow-y: auto; text-align: left; /* å…§å®¹é å·¦ */
  }
  /* å ±å‘Šå…§æ–‡æ¨£å¼ */
  .modal-body h1 { text-align: center; color: #003366; border-bottom: 2px solid #003366; padding-bottom: 10px; font-size: 24px; }
  .modal-body h2 { color: #003366; background: #f4f4f4; padding: 8px; border-left: 4px solid #cc0000; margin-top: 20px; font-size: 18px; }
  .modal-body code { background: #eee; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #003366; }
  .img-ref { max-width: 100%; border: 1px solid #ddd; margin: 10px 0; display: block; }

</style>
</head>
<body>

<div class="main-card" id="input-view">
    <h2>ğŸ“ TI-Nspire æ•¸å­¸å¯¦é©—å®¤</h2>
    <p class="desc">æˆ‘æ˜¯æ‚¨çš„ AI æ•¸å­¸æ•™æˆã€‚è«‹ä¸Šå‚³æ•¸å­¸é¡Œç›®åœ–åƒæˆ–ç›´æ¥è¼¸å…¥æ–¹ç¨‹å¼ã€‚æˆ‘å°‡ä½¿ç”¨ TI-Nspire CX II CAS çš„é‚è¼¯ç‚ºæ‚¨è§£æä¸¦æä¾›æ­¥é©Ÿã€‚</p>

    <div id="preview-area">
        <img id="preview-img" src="" alt="é¡Œç›®é è¦½">
        <div id="preview-pdf">PDF</div>
        <span id="file-name-preview">filename.pdf</span>
        <button id="remove-img-btn" onclick="clearFile()">Ã—</button>
    </div>

    <div class="input-group">
        <input type="file" id="file-input" accept="image/*, application/pdf" style="display: none;" onchange="handleFileSelect(this)">
        
        <button class="icon-btn" onclick="triggerFileUpload()" title="ä¸Šå‚³é¡Œç›®/æ•¸æ“š">
            ğŸ“‚
        </button>
        
        <input type="text" id="user-input" placeholder="è¼¸å…¥é¡Œç›® (ä¾‹å¦‚: Solve for x...)" onkeypress="handleEnter(event)">
        
        <button id="send-btn" onclick="callGeminiWorker()">è§£æ</button>
    </div>
</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">æ­£åœ¨é€²è¡Œé‹ç®—èˆ‡æ¨å°...</div>
    <p style="font-size:12px; color:#666; margin-top:10px;">Applying CAS Algorithms</p>
</div>

<div class="main-card" id="success-view">
    <div class="check-icon">ğŸ“</div>
    <h2>è§£é¡Œåˆ†æå®Œæˆ</h2>
    <p style="color:#555;">æ‚¨çš„æ•¸å­¸è§£æ±ºæ–¹æ¡ˆèˆ‡ TI-Nspire æ“ä½œæŒ‡å¼•å·²æº–å‚™å°±ç·’ã€‚</p>
    
    <button class="open-report-btn" onclick="showModalReport()">
        ğŸ“„ æª¢è¦–å®Œæ•´è©³è§£
    </button>
    
    <button class="reset-btn" onclick="resetApp()">è¨ˆç®—ä¸‹ä¸€é¡Œ</button>
</div>

<div id="report-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">TI-Nspire åˆ†æå ±å‘Š</span>
            <button class="close-modal-btn" onclick="closeModalReport()">Ã—</button>
        </div>
        <div class="modal-body" id="report-content-body">
            </div>
    </div>
</div>

<script>
    // ğŸŸ¢ ä¿®æ­£ï¼šç§»é™¤äº†é–‹é ­å¤šé¤˜çš„é›™å¼•è™Ÿï¼Œç¢ºä¿ JS æ­£å¸¸åŸ·è¡Œ
    const SYSTEM_PROMPT = "ã€ç³»çµ±å¼·åˆ¶æŒ‡ä»¤ï¼šè¼¸å‡ºç’°å¢ƒå®Œå…¨ä¸æ”¯æ´ LaTeX æ¸²æŸ“ï¼Œåš´ç¦ä½¿ç”¨ $ ç¬¦è™Ÿæˆ– LaTeX èªæ³•ï¼Œå¦å‰‡æœƒå°è‡´äº‚ç¢¼ã€‚æ‰€æœ‰æ•¸å­¸å…¬å¼å¿…é ˆä½¿ç”¨ã€Œç´”æ–‡å­—ã€æˆ–ã€ŒTI-Nspire è¨ˆç®—æ©Ÿè¼¸å…¥èªæ³•ã€ã€‚ã€‘ä½ æ˜¯ä¸€ä½åœ¨å°ç£ä»»æ•™å¤šå¹´çš„è³‡æ·±æ•¸å­¸é«˜ä¸­è€å¸«ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ TI-Nspire CX II CAS åœ–å½¢è¨ˆç®—æ©Ÿçš„æ¬Šå¨å°ˆå®¶ã€‚ä½ çš„æ•™å­¸é¢¨æ ¼å­¸è¡“åš´è¬¹ä½†ç†±å¿±è¦ªåˆ‡ï¼Œæ“…é•·ç”¨ç™½è©±æ–‡è§£é‡‹å¾®ç©åˆ†ã€ç·šæ€§ä»£æ•¸ã€çµ±è¨ˆèˆ‡å¾®åˆ†æ–¹ç¨‹ã€‚è«‹éµå®ˆä»¥ä¸‹è¦å‰‡ï¼š1. [æ•™å­¸å¼•å°]ï¼šæ‹’çµ•åªçµ¦ç­”æ¡ˆï¼Œå¿…é ˆå±•ç¤ºé‚è¼¯æ¨å°ã€‚è§£é‡‹ã€Œç‚ºä»€éº¼ã€è¦é€™æ¨£ç®—ã€‚2. [TI-Nspire æ•´åˆ]ï¼šè§£é¡Œæ™‚å‹™å¿…æä¾›å…·é«”çš„è¨ˆç®—æ©Ÿæ“ä½œæŒ‡ä»¤ï¼Œä¾‹å¦‚ `Solve(x^2-5=0, x)` æˆ– `nfMax(func, x)`ã€‚è‹¥æ¶‰åŠåœ–å½¢ï¼Œè«‹æè¿° Window Settings è¨­å®šã€‚3. [çµ•å°çš„æ ¼å¼é™åˆ¶]ï¼šä½ çš„æ•¸å­¸å¼å¿…é ˆé•·å¾—åƒç¨‹å¼ç¢¼ã€‚åˆ†æ•¸ç”¨ `/` (å¦‚ 1/2)ï¼Œæ ¹è™Ÿç”¨ `sqrt(...)`ï¼Œæ¬¡æ–¹ç”¨ `^` (å¦‚ x^2)ï¼Œç©åˆ†ç”¨ `integral(...)`ï¼Œå°æ•¸ç”¨ `d/dx(...)` æˆ– `y'`ã€‚ç¯„ä¾‹ï¼šä¸è¦å¯« `\frac{dy}{dx}`ï¼Œè¦å¯« `dy/dx`ã€‚ä¸è¦å¯« `\int`ï¼Œè¦å¯« `integral`ã€‚ç‰¹æ®Šç¬¦è™Ÿç›´æ¥å¯«è‹±æ–‡ (å¦‚ pi, theta, infinity)ã€‚4. [ç”¨èªè¦ç¯„]ï¼šåš´æ ¼ä½¿ç”¨å°ç£æ•™è‚²éƒ¨æ¨™æº–åè© (å¦‚ï¼šçŸ©é™£ã€å‘é‡ã€å°å‡½æ•¸ã€æ©Ÿç‡)ã€‚è«‹ä¿æŒèªæ°£å°ˆæ¥­å¹³æ˜“è¿‘äººï¼Œéš¨æ™‚ç¤ºç¯„è¨ˆç®—æ©Ÿæ“ä½œï¼Œä¸¦ç¢ºä¿æ‰€æœ‰è¼¸å‡ºçš†ç‚ºç´”æ–‡å­—æ ¼å¼ã€‚";
    
    // âš ï¸ è«‹ç¢ºä¿æ­¤ URL æ˜¯æ­£ç¢ºä¸”å¯å…¬é–‹å­˜å–çš„ (è·¨åŸŸ CORS éœ€å…è¨±)
    const WORKER_URL = "https://my-gemini-proxy.rockjonce.workers.dev"; 

    let currentBase64Data = null; 
    let currentMimeType = null;
    let currentFileName = "";
    let finalReportHTML = ""; 

    function switchView(viewName) {
        document.getElementById("input-view").style.display = (viewName === "input") ? "block" : "none";
        document.getElementById("loading-overlay").style.display = (viewName === "loading") ? "flex" : "none";
        document.getElementById("success-view").style.display = (viewName === "success") ? "block" : "none";
    }

    // ğŸŸ¢ æ–°å¢ï¼šå®‰å…¨çš„è§¸ç™¼ä¸Šå‚³
    function triggerFileUpload() {
        document.getElementById("file-input").click();
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            currentMimeType = file.type;
            currentFileName = file.name;

            if (file.size > 4 * 1024 * 1024) {
                alert("æª”æ¡ˆéå¤§ï¼è«‹ä¸Šå‚³ 4MB ä»¥ä¸‹çš„æ–‡ä»¶ã€‚");
                input.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewArea = document.getElementById("preview-area");
                const previewImg = document.getElementById("preview-img");
                const previewPdf = document.getElementById("preview-pdf");
                const nameLabel = document.getElementById("file-name-preview");

                // é‡ç½®é¡¯ç¤º
                previewImg.style.display = "none";
                previewPdf.style.display = "none";
                previewArea.style.display = "flex";
                
                nameLabel.innerText = file.name;

                if (file.type.startsWith("image/")) {
                    previewImg.src = e.target.result;
                    previewImg.style.display = "block";
                } else if (file.type === "application/pdf") {
                    previewPdf.style.display = "block";
                } else {
                    alert("ç›®å‰åƒ…æ”¯æ´ åœ–ç‰‡ æˆ– PDF æª”æ¡ˆè§£æã€‚");
                    clearFile();
                    return;
                }
                currentBase64Data = e.target.result.split(",")[1];
            };
            reader.onerror = function() { alert("æª”æ¡ˆè®€å–å¤±æ•—"); clearFile(); };
            reader.readAsDataURL(file);
        }
    }

    function clearFile() {
        const fileInput = document.getElementById("file-input");
        fileInput.value = "";
        document.getElementById("preview-area").style.display = "none";
        document.getElementById("preview-img").src = "";
        currentBase64Data = null; currentMimeType = null; currentFileName = "";
    }

    function resetApp() {
        clearFile();
        document.getElementById("user-input").value = "";
        switchView("input");
    }

    async function callGeminiWorker() {
        const userText = document.getElementById("user-input").value.trim();
        if (!userText && !currentBase64Data) {
            alert("è«‹è¼¸å…¥æ•¸å­¸é¡Œç›®æˆ–ä¸Šå‚³åœ–ç‰‡/æ•¸æ“š");
            return;
        }

        switchView("loading");

        try {
            let parts = [];
            let finalPrompt = userText;
            if (!finalPrompt) finalPrompt = "è«‹åˆ†æé€™é“æ•¸å­¸é¡Œç›®ä¸¦æä¾›è©³è§£ã€‚";

            if (SYSTEM_PROMPT && SYSTEM_PROMPT.trim() !== "") {
                finalPrompt = `${SYSTEM_PROMPT}\n\n[ä½¿ç”¨è€…å•é¡Œ]: ${finalPrompt}`;
            }

            parts.push({ text: finalPrompt });

            if (currentBase64Data) {
                parts.push({
                    inline_data: { mime_type: currentMimeType, data: currentBase64Data }
                });
            }

            const response = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });

            if (!response.ok) throw new Error(`Status: ${response.status}`);

            const data = await response.json();
            
            if (data.candidates && data.candidates.length > 0 && data.candidates[0].content) {
                let aiText = data.candidates[0].content.parts[0].text;
                aiText = aiText
                    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                    .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
                    .replace(/### (.*?)\n/g, "<h2>$1</h2>")
                    .replace(/## (.*?)\n/g, "<h2>$1</h2>")
                    .replace(/\n/g, "<br>");
                
                finalReportHTML = aiText;
                switchView("success");
            } else {
                throw new Error("ç„¡æ³•è§£æå›æ‡‰è³‡æ–™");
            }

        } catch (error) {
            console.error(error);
            alert("åˆ†æå¤±æ•—: " + error.message);
            switchView("input");
        }
    }

    // ğŸŸ¢ æ–°å¢ï¼šä½¿ç”¨ Modal é¡¯ç¤ºå ±å‘Š (Iframe Safe) ğŸŸ¢
    function showModalReport() {
        if (!finalReportHTML) return;
        
        const modal = document.getElementById("report-modal");
        const body = document.getElementById("report-content-body");
        
        // çµ„åˆå ±å‘Šå…§å®¹
        let content = `<h1>ğŸ“ è©³ç´°åˆ†æå ±å‘Š</h1>`;
        content += `<div style="text-align:center; color:#666; font-size:12px; margin-bottom:20px;">ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString()}</div>`;
        content += finalReportHTML;
        
        if (currentBase64Data && currentMimeType.startsWith("image")) {
            content += `<hr><p style="color:#888; text-align:center;">åŸå§‹é¡Œç›®å½±åƒï¼š</p>
                        <img src="data:${currentMimeType};base64,${currentBase64Data}" class="img-ref">`;
        }
        
        content += `<div style="margin-top:30px; text-align:center;">
                        <button onclick="window.print()" style="padding:10px 20px; background:#333; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ–¨ï¸ åˆ—å°æ­¤é </button>
                    </div>`;

        body.innerHTML = content;
        modal.style.display = "flex";
    }

    function closeModalReport() {
        document.getElementById("report-modal").style.display = "none";
    }

    function handleEnter(e) {
        if (e.key === "Enter") callGeminiWorker();
    }
</script>
</body>
</html>
