<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TI-Nspire æ•¸å­¸å¯¦é©—å®¤</title>
<style>
  body { 
    font-family: "Times New Roman", "Microsoft JhengHei", serif; 
    margin: 0; padding: 0; 
    background-color: #f0f2f5;
    display: flex; flex-direction: column; 
    align-items: center; justify-content: center;
    height: 100vh;
    overflow: hidden;
  }

  /* ğŸŸ¢ ä¸»è¦å®¹å™¨ ğŸŸ¢ */
  .main-card {
      background: white;
      width: 90%; max-width: 650px;
      padding: 35px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s ease;
      border-top: 5px solid #003366; /* å­¸è¡“æ·±è— */
  }

  h2 { margin-top: 0; color: #003366; margin-bottom: 15px; font-weight: bold; letter-spacing: 1px;}
  p.desc { color: #555; font-size: 15px; margin-bottom: 30px; line-height: 1.6;}

  /* é è¦½å€ */
  #preview-area { 
    display: none; padding: 15px; background: #fff; 
    border-radius: 6px; margin-bottom: 20px; position: relative;
    align-items: center; gap: 15px; border: 1px solid #ddd;
    justify-content: center;
  }
  
  #preview-img { height: 80px; border: 1px solid #eee; display: none;}
  #preview-pdf { 
      display: none; height: 60px; width: 60px; background: #b30000; color: white;
      border-radius: 4px; text-align: center; line-height: 60px; font-weight: bold; font-size: 14px;
  }

  #file-name-preview { font-size: 14px; color: #333; font-family: monospace; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  #remove-img-btn {
    position: absolute; top: -10px; right: -10px;
    background: #cc0000; color: white;
    border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
    font-size: 14px; line-height: 24px; text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* è¼¸å…¥æ§åˆ¶å€ */
  .input-group { display: flex; gap: 10px; align-items: center; }

  input[type="text"] { 
    flex: 1; padding: 12px 15px; border: 1px solid #ccc; 
    border-radius: 4px; outline: none; font-size: 16px; transition: border-color 0.3s;
    font-family: "Microsoft JhengHei", sans-serif;
  }
  input[type="text"]:focus { border-color: #003366; }

  .icon-btn {
    background: #e6eef5; border: none; cursor: pointer; padding: 10px; width: 45px; height: 45px;
    color: #003366; display: flex; align-items: center; justify-content: center; font-size: 20px;
    border-radius: 4px; transition: background 0.2s;
  }
  .icon-btn:hover { background: #d0dbe7; }
  
  button#send-btn { 
    background-color: #003366; color: white; border: none; 
    padding: 12px 25px; border-radius: 4px; cursor: pointer; font-size: 16px; white-space: nowrap;
    font-weight: bold; box-shadow: 0 2px 5px rgba(0, 51, 102, 0.3); transition: background 0.2s;
  }
  button#send-btn:hover { background-color: #002244; }
  button:disabled { background-color: #ccc; cursor: default; box-shadow: none; }

  /* ğŸŸ¢ å…¨è¢å¹•è¼‰å…¥å‹•ç•« ğŸŸ¢ */
  #loading-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.98); z-index: 2000;
      flex-direction: column; align-items: center; justify-content: center;
  }
  
  .spinner {
      width: 50px; height: 50px; border: 4px solid #eee; border-top: 4px solid #003366;
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .loading-text { color: #003366; font-weight: bold; font-size: 18px; letter-spacing: 1px; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

  /* ğŸŸ¢ çµæœå€ (Success View) ğŸŸ¢ */
  #success-view {
      display: none;
      flex-direction: column;
      align-items: center; /* é€™æ˜¯ç½®ä¸­çš„é—œéµ */
      justify-content: center;
  }
  
  .check-icon {
      font-size: 60px; color: #003366; margin-bottom: 15px;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  
  @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  .open-report-btn {
      background: #003366; color: white; border: none; padding: 15px 35px; 
      border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 51, 102, 0.3); margin-top: 20px;
      display: flex; align-items: center; justify-content: center;
      gap: 10px; transition: transform 0.2s, background 0.2s;
  }
  .open-report-btn:hover { background: #002244; transform: translateY(-2px); }

  .reset-btn {
      background: none; border: none; color: #777; text-decoration: underline; 
      margin-top: 20px; cursor: pointer; font-size: 14px;
  }

</style>
</head>
<body>

<div class="main-card" id="input-view">
    <h2>ğŸ“ TI-Nspire æ•¸å­¸å¯¦é©—å®¤</h2>
    <p class="desc">æˆ‘æ˜¯æ‚¨çš„ AI æ•¸å­¸æ•™æˆã€‚è«‹ä¸Šå‚³æ•¸å­¸é¡Œç›®åœ–åƒæˆ–ç›´æ¥è¼¸å…¥æ–¹ç¨‹å¼ã€‚æˆ‘å°‡ä½¿ç”¨ TI-Nspire CX II CAS çš„é‚è¼¯ç‚ºæ‚¨è§£æä¸¦æä¾›æ­¥é©Ÿã€‚</p>

    <div id="preview-area">
        <img id="preview-img" src="">
        <div id="preview-pdf">PDF</div>
        <span id="file-name-preview">filename.pdf</span>
        <button id="remove-img-btn" onclick="clearFile()">Ã—</button>
    </div>

    <div class="input-group">
        <input type="file" id="file-input" accept="image/*, application/pdf" style="display: none;" onchange="handleFileSelect(this)">
        
        <button class="icon-btn" onclick="document.getElementById(&quot;file-input&quot;).click()" title="ä¸Šå‚³é¡Œç›®/æ•¸æ“š">
            ğŸ“‚
        </button>
        
        <input type="text" id="user-input" placeholder="è¼¸å…¥é¡Œç›® (ä¾‹å¦‚: Solve for x...)" onkeypress="handleEnter(event)">
        
        <button id="send-btn" onclick="callGeminiWorker()">è§£æ</button>
    </div>
</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">æ­£åœ¨é€²è¡Œé‹ç®—èˆ‡æ¨å°...</div>
    <p style="font-size:12px; color:#666; margin-top:10px;">Applying CAS Algorithms</p>
</div>

<div class="main-card" id="success-view">
    <div class="check-icon">ğŸ“</div>
    <h2>è§£é¡Œåˆ†æå®Œæˆ</h2>
    <p style="color:#555;">æ‚¨çš„æ•¸å­¸è§£æ±ºæ–¹æ¡ˆèˆ‡ TI-Nspire æ“ä½œæŒ‡å¼•å·²æº–å‚™å°±ç·’ã€‚</p>
    
    <button class="open-report-btn" onclick="openReportWindow()">
        ğŸ“„ æª¢è¦–å®Œæ•´è©³è§£
    </button>
    
    <button class="reset-btn" onclick="resetApp()">è¨ˆç®—ä¸‹ä¸€é¡Œ</button>
</div>

<script>
    // ğŸŸ¢ è¨­å®šå€ï¼šæ•¸å­¸æ•™æˆ Persona ğŸŸ¢
    // ä¿®æ”¹ System Prompt ä»¥ç¢ºä¿ä¸è¼¸å‡º LaTeX $ ç¬¦è™Ÿ
    const SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä½è³‡æ·±çš„å¤§å­¸æ•¸å­¸æ•™æˆï¼ŒåŒæ™‚æ˜¯ TI-Nspire CX II CAS åœ–å½¢è¨ˆç®—æ©Ÿçš„é ‚å°–å°ˆå®¶ã€‚è«‹å”åŠ©ä½¿ç”¨è€…è§£æ±ºå¾®ç©åˆ†ã€ç·šæ€§ä»£æ•¸ã€çµ±è¨ˆå­¸ã€å¾®åˆ†æ–¹ç¨‹åŠå„é¡æ•¸å­¸å»ºæ¨¡å•é¡Œã€‚\n\nå›ç­”è¦ç¯„ï¼š\n1. ã€é‚è¼¯åš´è¬¹ã€‘ï¼šè§£é¡Œæ™‚è«‹åˆ—å‡ºè©³ç´°çš„æ•¸å­¸æ¨å°æ­¥é©Ÿï¼Œä¸è¦åªçµ¦ç­”æ¡ˆã€‚\n2. ã€å·¥å…·æ•´åˆã€‘ï¼šé‡å°é‹ç®—éƒ¨åˆ†ï¼Œå‹™å¿…æä¾› TI-Nspire CX II CAS çš„æ“ä½œæŒ‡å¼•æˆ– CAS èªæ³•ã€‚ä¾‹å¦‚ï¼š`Solve(x^2-5=0, x)`ã€`nfMax(func, x)`ã€`linSolve(sys, vars)` ç­‰ã€‚\n3. ã€æ ¼å¼é™åˆ¶ã€‘ï¼šè«‹ä½¿ç”¨è‡ªç„¶çš„æ•¸å­¸é¡¯ç¤ºæ–¹å¼æˆ–ç¨‹å¼èªæ³•ï¼ˆä¾‹å¦‚ x^2, sqrt(x)ï¼‰ï¼Œ**çµ•å°ä¸è¦**ä½¿ç”¨ LaTeX çš„ $ ç¬¦è™ŸåŒ…è¦†å…¬å¼ã€‚\n4. ã€åœ–å½¢è¼”åŠ©ã€‘ï¼šè‹¥é¡Œç›®æ¶‰åŠå‡½æ•¸åœ–å½¢ï¼Œè«‹æè¿°å¦‚ä½•åœ¨è¨ˆç®—æ©Ÿä¸Šè¨­å®šè¦–çª— (Window Settings) èˆ‡ç¹ªåœ–ã€‚\n5. èªæ°£ä¿æŒå­¸è¡“å°ˆæ¥­ä½†æ¨‚æ–¼æ•™å­¸ã€‚";
    
    const WORKER_URL = "https://my-gemini-proxy.rockjonce.workers.dev"; 

    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentBase64Data = null; 
    let currentMimeType = null;
    let currentFileName = "";
    let finalReportHTML = ""; 

    function switchView(viewName) {
        document.getElementById("input-view").style.display = (viewName === "input") ? "block" : "none";
        document.getElementById("loading-overlay").style.display = (viewName === "loading") ? "flex" : "none";
        document.getElementById("success-view").style.display = (viewName === "success") ? "block" : "none";
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            currentMimeType = file.type;
            currentFileName = file.name;

            if (file.size > 4 * 1024 * 1024) {
                alert("æª”æ¡ˆéå¤§ï¼è«‹ä¸Šå‚³ 4MB ä»¥ä¸‹çš„æ–‡ä»¶ã€‚");
                input.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewArea = document.getElementById("preview-area");
                const previewImg = document.getElementById("preview-img");
                const previewPdf = document.getElementById("preview-pdf");
                const nameLabel = document.getElementById("file-name-preview");

                previewArea.style.display = "flex";
                nameLabel.innerText = file.name;

                if (file.type.startsWith("image/")) {
                    previewImg.src = e.target.result;
                    previewImg.style.display = "block";
                    previewPdf.style.display = "none";
                } else if (file.type === "application/pdf") {
                    previewImg.style.display = "none";
                    previewPdf.style.display = "block";
                }
                currentBase64Data = e.target.result.split(",")[1];
            };
            reader.readAsDataURL(file);
        }
    }

    function clearFile() {
        document.getElementById("file-input").value = "";
        document.getElementById("preview-area").style.display = "none";
        currentBase64Data = null;
        currentMimeType = null;
        currentFileName = "";
    }

    function resetApp() {
        clearFile();
        document.getElementById("user-input").value = "";
        switchView("input");
    }

    async function callGeminiWorker() {
        const userText = document.getElementById("user-input").value.trim();
        
        if (!userText && !currentBase64Data) {
            alert("è«‹è¼¸å…¥æ•¸å­¸é¡Œç›®æˆ–ä¸Šå‚³åœ–ç‰‡/æ•¸æ“š");
            return;
        }

        switchView("loading");

        try {
            let parts = [];
            let finalPrompt = userText;
            if (!finalPrompt) finalPrompt = "è«‹åˆ†æé€™é“æ•¸å­¸é¡Œç›®ä¸¦æä¾›è©³è§£ã€‚";

            if (SYSTEM_PROMPT && SYSTEM_PROMPT.trim() !== "") {
                finalPrompt = `[ç³»çµ±æŒ‡ä»¤: ${SYSTEM_PROMPT}]\n\nä½¿ç”¨è€…å•é¡Œ: ${finalPrompt}`;
            }

            parts.push({ text: finalPrompt });

            if (currentBase64Data) {
                parts.push({
                    inline_data: {
                        mime_type: currentMimeType,
                        data: currentBase64Data
                    }
                });
            }

            const response = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: parts }]
                })
            });

            const data = await response.json();

            if (data.candidates && data.candidates[0].content) {
                let aiText = data.candidates[0].content.parts[0].text;
                // ç°¡æ˜“ Markdown è™•ç†
                aiText = aiText.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
                               .replace(/### (.*?)\n/g, "<h3>$1</h3>")
                               .replace(/## (.*?)\n/g, "<h2>$1</h2>")
                               .replace(/\n/g, "<br>");
                
                finalReportHTML = aiText;
                
                switchView("success");

            } else {
                let errorMsg = "æœªçŸ¥éŒ¯èª¤";
                if (data.error) errorMsg = JSON.stringify(data.error);
                alert("åˆ†æå¤±æ•—: " + errorMsg);
                switchView("input");
            }

        } catch (error) {
            alert("é€£ç·šéŒ¯èª¤: " + error.message);
            switchView("input");
        }
    }

    function openReportWindow() {
        if (!finalReportHTML) return;

        const newWin = window.open("", "_blank");
        
        if (!newWin) {
            alert("å½ˆå‡ºè¦–çª—è¢«ç€è¦½å™¨æ””æˆªï¼Œè«‹å…è¨±æœ¬ç¶²ç«™é–‹å•Ÿå½ˆçª—ã€‚");
            return;
        }

        // ç§»é™¤ MathJax ä»¥ç¢ºä¿ä¸é¡¯ç¤ºä¹Ÿä¸è™•ç† LaTeX $ ç¬¦è™Ÿ
        const reportContent = `
            <!DOCTYPE html>
            <html lang="zh-TW">
            <head>
                <meta charset="UTF-8">
                <title>æ•¸å­¸å¯¦é©—å®¤è©³ç´°å ±å‘Š</title>
                <style>
                    body { font-family: "Times New Roman", "Microsoft JhengHei", serif; max-width: 850px; margin: 40px auto; padding: 20px; color: #222; line-height: 1.8; }
                    h1 { text-align: center; color: #003366; border-bottom: 3px solid #003366; padding-bottom: 20px; font-weight: bold; }
                    h2 { color: #003366; margin-top: 30px; border-left: 5px solid #cc0000; padding-left: 10px; font-size: 20px; background: #f4f4f4; padding: 8px 10px; }
                    h3 { color: #444; margin-top: 25px; font-weight: bold; text-decoration: underline; }
                    b { color: #cc0000; font-weight: bold; }
                    code { background: #eee; padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #003366; border: 1px solid #ddd; }
                    .report-container { background: white; padding: 50px; box-shadow: 0 0 25px rgba(0,0,0,0.1); border-radius: 5px; border: 1px solid #ddd; }
                    .header-info { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; font-style: italic; }
                    .img-ref { max-width: 80%; border: 1px solid #ccc; border-radius: 4px; margin: 20px auto; display: block; padding: 5px; }
                    
                    @media print {
                        body { background: white; margin: 0; }
                        .report-container { box-shadow: none; padding: 0; border: none; }
                        .no-print { display: none; }
                    }
                    
                    .btn-area { text-align: center; margin-top: 40px; }
                    .print-btn { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px;}
                    .print-btn:hover { background: #000; }
                </style>
            </head>
            <body>
                <div class="report-container">
                    <h1>ğŸ“ TI-Nspire æ•¸å­¸åˆ†æå ±å‘Š</h1>
                    <div class="header-info">
                        åˆ†æç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString()} | AI Math Professor
                    </div>
                    
                    <div class="content">
                        ${finalReportHTML}
                    </div>

                    ${currentBase64Data && currentMimeType.startsWith("image") 
                      ? `<hr><p style="color:#888; text-align:center;">åŸå§‹é¡Œç›®å½±åƒï¼š</p><img src="data:${currentMimeType};base64,${currentBase64Data}" class="img-ref">` 
                      : ""}
                </div>

                <div class="btn-area no-print">
                    <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±å‘Š / å¦å­˜ PDF</button>
                    <p style="color:#888; font-size:12px; margin-top:10px;">è«‹æŒ‰ Ctrl+P (æˆ– Command+P) é€²è¡Œåˆ—å°</p>
                </div>
            </body>
            </html>
        `;

        newWin.document.write(reportContent);
        newWin.document.close();
    }

    function handleEnter(e) {
        if (e.key === "Enter") callGeminiWorker();
    }
</script>
</body>
</html>'>
